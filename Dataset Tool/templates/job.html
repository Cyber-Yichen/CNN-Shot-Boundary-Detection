<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Job {{ job.job_id }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 18px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-light">
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <div class="h5 mb-0">任务详情</div>
      <div class="text-secondary small mono">BUILD: {{ build_id }}</div>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">返回</a>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-6">
          <div class="text-secondary small">Job ID</div>
          <div class="mono">{{ job.job_id }}</div>
        </div>
        <div class="col-md-3">
          <div class="text-secondary small">Video</div>
          <div>{{ job.video_name }}</div>
        </div>
        <div class="col-md-3">
          <div class="text-secondary small">Mode</div>
          <div>{{ job.mode }}</div>
        </div>

        <div class="col-md-12"><hr class="my-2"/></div>

        <div class="col-md-3">
          <div class="text-secondary small">Status</div>
          <div id="status" class="fw-semibold">{{ job.status }}</div>
        </div>
        <div class="col-md-9">
          <div class="text-secondary small">Message</div>
          <div id="message" class="text-secondary">{{ job.message }}</div>
        </div>

        <div class="col-md-12">
          <div class="progress" role="progressbar" aria-label="progress">
            <div id="bar" class="progress-bar" style="width: 0%"></div>
          </div>
          <div class="text-secondary small mt-1">
            <span id="prog">0</span> / <span id="total">0</span>
          </div>
        </div>

        <div class="col-md-12"><hr class="my-2"/></div>

        <div class="col-md-12">
          <div class="text-secondary small">Outputs</div>
          <pre id="outputs" class="mono bg-white p-2 border rounded" style="min-height: 120px; white-space: pre-wrap;">(waiting...)</pre>
        </div>

        <div class="col-md-12">
          <div class="text-secondary small">Error Trace</div>
          <pre id="trace" class="mono bg-white p-2 border rounded" style="min-height: 90px; white-space: pre-wrap;"></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const jobId = "{{ job.job_id }}";

function pct(progress, total) {
  if (!total || total <= 0) return 0;
  let p = Math.floor((progress / total) * 100);
  if (p < 0) p = 0;
  if (p > 100) p = 100;
  return p;
}

async function refreshJob() {
  const res = await fetch(`/api/job/${jobId}`);
  if (!res.ok) return;
  const j = await res.json();

  document.getElementById("status").textContent = j.status;
  document.getElementById("message").textContent = j.message || "";
  document.getElementById("prog").textContent = j.progress || 0;
  document.getElementById("total").textContent = j.total || 0;

  const p = pct(j.progress, j.total);
  document.getElementById("bar").style.width = p + "%";
  document.getElementById("bar").textContent = p + "%";

  if (j.outputs) {
    document.getElementById("outputs").textContent = JSON.stringify(j.outputs, null, 2);
  } else {
    document.getElementById("outputs").textContent = "(no outputs yet)";
  }

  document.getElementById("trace").textContent = j.error_trace || "";

  if (j.status === "done" || j.status === "error") {
    return; // stop polling
  }
  setTimeout(refreshJob, 1200);
}

refreshJob();
</script>
</body>
</html>
